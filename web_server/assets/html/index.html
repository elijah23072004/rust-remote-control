<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>"home"</title>
        <link rel="stylesheet" href="assets/css/style.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <script type="text/javascript" src="assets/js/crypto.js"></script>
    </head>
    <body onload="initialise()">
        <div id="volume">
            <p id="currentVolume"></p>
            <p> % volume</p>
            <button onclick="getCurrentVolume()">Get current volume </button>
            <button onclick="offsetVolume(-5)"> -5% Volume </button>
            <button onclick="offsetVolume(5)"> +5% Volume </button>
            <p> Volume</p>
            <input type="range" min="0" max="100" value="50" class="slider" id="volumeSlider" oninput="setVolume()">
            <p id="volumeValue"></p>
            <button onclick="volumeSubmit()"> Submit volume change </button> 
            <br><br>
            <button onclick="toggleScreen()"> Toggle laptop screen </button>
            <button onclick="setBrightness(0)">Set laptop brightness to 0%</button>
            <button onclick="setBrightness(50)">Set laptop brightness to 50%</button>
            <button onclick="setBrightness(100)">Set laptop brightness to 100</button>
            <br><br><br>
            <select id="player">
                <option value="">--Please choose a player--</option>
            </select>
            <button onclick="previousPlayer()"> Previous</button>
            <button onclick="playPause()"> Play Pause </button>
            <button onclick="nextPlayer()"> Next </button>
            <button onclick="getPlayers()"> Refresh players </button>
            <button onclick="getPlayingMediaTitle()"> Get currently playing media</button>
            <button onclick="toggle_shuffle()">Toggle shuffle</button>
                
            <p> Curreny playing media:
            <p id="playingMedia"></p>
        </div>
    <script>

        let encryption_key;
        let identifier;
        function sendData(data, successFunc= () => {})
    {
        $.ajax({
            type: "POST",
            url:"/sendCommand/",
            data: data,
            success: function(data){
                console.log(data)
                successFunc(data)
            },
            failure: function(){
                console.log("Failed to send data")
            }
        });
    }
    
    function toggleScreen()
    {
        sendData("action,toggleScreen")
    }
    function setBrightness(num)
    {
        sendData("action,setBrightness,"+num);
    }
    function volumeSubmit()
    {
        let volumeSlider = document.getElementById("volumeSlider");
        let value = volumeSlider.value;
        let data = "action,setVolume,"+value;
        sendData(data, getCurrentVolume);
    }
    function setVolume()
    {
        document.getElementById("volumeValue").textContent=document.getElementById("volumeSlider").value;
    }
    function getCurrentVolume()
    {
        sendData("action, getVolume", (val) => document.getElementById("currentVolume").textContent=val);
    }
    function offsetVolume(offset)
    {
        let value =  document.getElementById("currentVolume").textContent;
        let newVal = Number(value) + offset;
        let data ="action,setVolume,"+newVal;
        document.getElementById("volumeSlider").value=newVal;
        document.getElementById("volumeValue").textContent=newVal;
        sendData(data,getCurrentVolume);
    }
    async function initialise()
    {
        await initialiseEncryption();
        getCurrentVolume()
        setVolume()
        getPlayers()
    }
    
    function previousPlayer()
    {
        let player = document.getElementById("player").value;
        if (player=="") return;
        sendData("action,previousMediaPlayer,"+player);
    }
    function nextPlayer()
    {
        let player = document.getElementById("player").value;
        if (player=="") return;
        sendData("action,nextMediaPlayer,"+player);
    }
    function playPause()
    {
        let player = document.getElementById("player").value;
        if (player=="") return;
        sendData("action,playPauseMediaPlayer,"+ player);
    }
    function getPlayersDropDown(players)
    {
        players = players.trim();
        let player_select = document.getElementById("player");
        player_select.innerHTML="";
        option_placeholder = document.createElement("option");
        option_placeholder.setAttribute("value","");
        option_placeholder.innerHTML="-- Please choose a player--";
        player_select.appendChild(option_placeholder);
        players.split("\n").forEach(function (player) {
            let option = document.createElement("option");
            option.setAttribute("value",player);
            option.innerHTML = player;
            player_select.appendChild(option);
        });
    }
    function getPlayers()
    {
        sendData("action,getPlayers",getPlayersDropDown);
    }
    function getPlayingMediaTitle()
    {
        let player=document.getElementById("player").value;
        if(player=="") return;
            sendData("action, getPlayingMedia,"+player,(response) => document.getElementById("playingMedia").innerText=response);
    }
    function toggle_shuffle()
    {
        let player = document.getElementById("player").value;
        if (player =="") return;
        sendData("action,toggleShuffle,"+player);
    }
    async function initialiseEncryption()
    {
        let password = window.prompt("Enter your password");
        let nonce= window.crypto.getRandomValues(new Uint8Array(16));
        //console.log("unencrypted data is:");
        //console.log(nonce);
        let key = await generateKey(password);
        let ciphertext = await encrypt(nonce,key);
        let cipherBuffer = new Uint8Array(ciphertext,0,ciphertext.byteLength)
        let bufferLen = ciphertext.byteLength + saltLen + ivLen; 
        let buffer = new Uint8Array(bufferLen);
        buffer.set(salt);
        buffer.set(iv,saltLen);
        buffer.set(cipherBuffer,(saltLen+ivLen));
        
        console.log(buffer);
        
        const req = new XMLHttpRequest();
        req.open ("POST", "/initialiseConnection/", true);
        req.responseType = "blob";
        req.onload = async function() {
                if (this.status === 200) {
                    console.log("making blob");
                    var blob = new Blob([req.response]);
                    handleResponse(blob,key,nonce);
                } 
                else {
                    console.log("failed to initialse connection");
                    console.log(this.status);
                    window.location.reload();
                }
        }
        req.send(buffer)
        
    }
    //takes arrayBuffer containing iv then ciphertext
    async function handleResponse(blob,key,oldNonce)
    {
            let data;
            var fileReader = new FileReader();
            fileReader.onload = async function(event) {
                arrayBuffer = event.target.result;
                data = new Uint8Array(arrayBuffer);

                iv = data.slice(0,12);
                console.log("iv:");
                console.log(iv);
                cipher = data.slice(12);
                console.log("ciphertext:");
                console.log(cipher);
                //key = await getKey(getKeyMaterial("password"), salt);
                let plaintext = await decrypt(cipher, key);
                if (plaintext == null) {
                    alert("invalid decryption");
                    window.location.reload();
                    return;
                }
                //plaintext is array buffer of 32 bytes with first 16 being old nonce need to check if old nonce is still valid 
                let originalNonce = plaintext.slice(0,16);
                //cehck if old nonce is same as one send
                if (isEqual(originalNonce,oldNonce)) {
                    encryption_key = plaintext.slice(16);
                    identifier=originalNonce;
                    console.log("successful encryption initialisation") 
                    //here the callback for the rest of the initialisation will be done
                    return;
                }
                else {
                    alert("returned nonce is not the same as the one generated");
                    window.location.reload();
                }
            };
            fileReader.readAsArrayBuffer(blob);
    }
    function isEqual(array1, array2)
    {
        if(array1.length != array2.length) {return false}
        for (let i=0; i<array1.length; i++)
        {
            if(array1[i]!=array2[i]){return false}
        }
        return true;
    }
    </script>
    </body>
</html>
